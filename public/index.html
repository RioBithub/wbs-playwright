<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JR SQA by Deva ‚Äî Multi Web (Health + Scheduler)</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0e1324; --card:#0f172a; --ink:#e5e7eb; --mut:#94a3b8;
      --acc:#7c3aed; --acc2:#22d3ee; --ok:#22c55e; --err:#ef4444; --warn:#f59e0b; --line:rgba(255,255,255,.08)
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:radial-gradient(1200px 800px at 20% -10%, rgba(124,58,237,.25), transparent),
                 linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink)
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo {
  width: 42px;
  height: 42px;
  border-radius: 12px;
  background: url("https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwlWLOk0afIuE8DUGKcnXwwmvzLqkx8-KbXw&s") center/contain no-repeat #fff;
  border: 2px solid rgba(255,255,255,.1);
  box-shadow: 0 8px 28px rgba(124,58,237,.35);
}


    .brand h1 {font-size:20px;font-weight:800;margin:0;color:#fff} header .mutetxt{font-size:13px;opacity:.8}
.tab {transition:all .25s}
.tab:hover{border-color:var(--acc2);background:rgba(34,211,238,.08)}
.tab.active{border-color:var(--acc);background:linear-gradient(180deg,rgba(124,58,237,.25),rgba(15,23,42,.6))}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;
      background:rgba(15,23,42,.6);backdrop-filter:blur(6px);cursor:pointer;user-select:none
    }
    .tab a{color:#a78bfa;text-decoration:none;font-weight:700}
    .grid{display:grid;grid-template-columns: 1fr 400px;gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr} }

    .window,.side .card{
  border-radius:18px;
  box-shadow:0 12px 40px rgba(0,0,0,.4);
}

    .window{border:1px solid var(--line);border-radius:16px;background:rgba(15,23,42,.75);backdrop-filter:blur(6px);box-shadow:0 20px 60px rgba(0,0,0,.35);overflow:hidden}
    .titlebar{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.04),transparent)}
    .dots{display:flex;gap:6px;margin-right:6px}
    .dot{width:10px;height:10px;border-radius:999px}.r{background:#ef4444}.y{background:#f59e0b}.g{background:#22c55e}
    .title{font-weight:800}
    .content{padding:14px}
    .section{border:1px dashed var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
    .section h3{margin:0 0 8px 0;font-size:14px;color:var(--mut)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .actions {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
  margin-left:10px; /* <<< kasih jarak ke kiri (pill) */
}

    button{border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .primary{background:var(--acc);color:#fff}.muted{background:#171c2b;color:var(--ink)}.danger{background:#ef4444;color:#fff}
    .pill {
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  margin-right:8px; /* <<< Tambahin ini */
}

    .ok{background:rgba(34,197,94,.18);color:#86efac}.warn{background:rgba(245,158,11,.18);color:#fde68a}.err{background:rgba(239,68,68,.18);color:#fecaca}
    .checkgrid{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    .check{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#0b1020}
    .state{font-weight:900}
    .state.ok{color:#86efac}.state.err{color:#fecaca}.state.na{color:#94a3b8}
    .side .card{border:1px solid var(--line);border-radius:16px;background:rgba(15,23,42,.75);backdrop-filter:blur(6px);padding:14px}
    .side h3{margin:0 0 10px 0}
    input, select{background:#0b1020;color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:10px 12px;outline:none}
    input[type=number]{width:120px}
    pre{white-space:pre-wrap;background:#0b1020;border:1px solid var(--line);padding:10px;border-radius:12px;max-height:260px;overflow:auto}
    .hidden{display:none}
    .linkrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .linkrow a{color:#a78bfa;text-decoration:none;font-weight:800}
    .mutetxt{color:var(--mut);font-size:12px}
    .list{display:flex;flex-direction:column;gap:6px}
    .fail-item{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0b1020}
    .fail-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .fail-links{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .chip.err{background:rgba(239,68,68,.18);color:#fecaca;border-color:rgba(239,68,68,.35)}
    .timestamp {
  background: none !important;
  margin-left: 8px;
  color: var(--mut);
  font-weight: normal;
}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>JR SQA by Deva ‚Äî Multi Web (Health + Scheduler)</h1>
          <div class="mutetxt">UI ramah non-teknis: tampil ‚Äú‚úÖ bisa / ‚ùå gak bisa‚Äù per halaman/API + log per website + daftar test yang gagal.</div>
        </div>
      </div>
      <nav class="tabs" id="tabs"></nav>
    </header>

    <div class="grid">
      <!-- LEFT: jendela per website -->
      <div id="windows"></div>

      <!-- RIGHT: scheduler & log global + failures -->
      <aside class="side">
        <div class="card">
          <h3>Scheduler (Playwright global)</h3>
          <div class="row" style="margin-bottom:10px">
            <div><label>Menit</label><input id="minutes" type="number" min="1" value="1" /></div>
            <div><label>Jam</label><input id="hours" type="number" min="1" value="6" /></div>
            <div><label>Mode</label>
              <select id="mode"><option value="minutes">Menit</option><option value="hours">Jam</option></select>
            </div>
          </div>
          <div class="actions">
            <button class="primary" id="btnRun">‚ñ∂ Jalankan Sekali</button>
            <button class="muted" id="btnStart">‚è±Ô∏è Set Auto-run</button>
            <button class="danger" id="btnStop">üõë Stop Auto-run</button>
          </div>
          <div id="statusBox" style="margin-top:10px">Memuat‚Ä¶</div>
          <div class="linkrow" style="margin-top:8px">
            <a href="/playwright-report/index.html" target="_blank">HTML Report</a>
            <a href="/playwright-report/data/report.json" target="_blank">JSON Report</a>
          </div>
        </div>

        <div class="card">
          <h3>Logs (global)</h3>
          <pre id="logs">Memuat‚Ä¶</pre>
        </div>

        <div class="card">
          <h3>Gagal (Playwright)</h3>
          <div id="pwFailSummary" class="mutetxt">Memuat ringkasan‚Ä¶</div>
          <div id="pwFailures" class="list" style="margin-top:8px"></div>
        </div>
      </aside>
    </div>
  </div>

<script>

const PROJECT_LABELS = {
  jr: "WBS Jasa Raharja",
  spjr: "SP Jasa Raharja"
};

    
/* ===== helper DOM & API ===== */
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild; }
async function api(path, opts){
  const r = await fetch(path, opts);
  if(!r.ok){ throw new Error(await r.text()); }
  const ct = r.headers.get('content-type') || '';
  return ct.includes('application/json') ? r.json() : r.text();
}
function fmtDur(ms){ if(ms==null) return '-'; const s=Math.round(ms/1000),m=Math.floor(s/60),ss=s%60; return m?(m+'m '+ss+'s'):(ss+'s'); }
function pill(ok){ return `<span class="pill ${ok?'ok':'err'}">${ok?'‚úÖ Semua bisa':'‚ùå Ada yang gagal'}</span>`; }
function state(ok){ return `<span class="state ${ok===true?'ok':ok===false?'err':'na'}">${ok===true?'bisa':ok===false?'gak bisa':'‚Äì'}</span>`; }

/* ===== build UI dari /site/list ===== */
const tabsEl = document.getElementById('tabs');
const winsEl = document.getElementById('windows');

async function loadSites(){
  let sites = [];
  try{
    const j = await api('/site/list');
    sites = j.sites || [];
    SITE_KEYS = sites.map(s => s.key);

  }catch(e){
    tabsEl.innerHTML = '<div class="tab active">Gagal memuat daftar site</div>';
    winsEl.innerHTML = '<div class="window"><div class="titlebar"><div class="title">Error</div></div><div class="content">Tidak bisa memuat /site/list: '+e.message+'</div></div>';
    return;
  }

  // Tabs
  tabsEl.innerHTML = '';
  sites.forEach((s, idx) => {
  const tab = el(`<div class="tab ${idx===0?'active':''}" data-tab="${s.key}">
    <span>üåê</span><a href="#page">${s.name}</a>
  </div>`);
  tabsEl.appendChild(tab);
});


  // Windows
  winsEl.innerHTML = '';
  sites.forEach((s, idx) => {
    const win = el(`
      <div class="window ${idx===0?'':'hidden'}" data-win="${s.key}">
        <div class="titlebar">
          <div class="dots"><div class="dot r"></div><div class="dot y"></div><div class="dot g"></div></div>
          <div class="title">${s.name} ‚Äî Kesehatan Website</div>
        </div>
        <div class="content">
          <div class="section">
            <div class="row" style="justify-content:space-between;align-items:center">
              <h3 style="margin:0">Ringkasan</h3>
              <div class="actions">
                <button class="primary" data-action="check" data-site="${s.key}">üîç Cek Sekarang</button>
                <button class="muted" data-action="check-all">üîé Cek Semua</button>
                <a class="muted" style="text-decoration:none;padding:10px 12px;border-radius:12px;border:1px solid var(--line)" href="${s.base}" target="_blank" rel="noopener">üåê Buka ${s.name}</a>
              </div>
            </div>
            <div id="summary-${s.key}" class="pill warn">Belum dicek</div>
          </div>

          <div class="section">
            <h3>Detail Per Halaman/API</h3>
            <div id="checks-${s.key}" class="checkgrid">
              ${ (s.checks||[]).map(lbl => `
                <div class="check">
                  <div><b>${lbl}</b> <span class="mutetxt">(belum dicek)</span></div>
                  <div>${state(null)}</div>
                </div>
              `).join('') }
            </div>
          </div>

          <div class="section">
            <h3>Riwayat (dedicated log)</h3>
            <div id="sitelogs-${s.key}" class="list mutetxt">Belum ada riwayat</div>
          </div>
        </div>
      </div>
    `);
    winsEl.appendChild(win);
  });

  // Tab switching
  tabsEl.addEventListener('click', (e)=>{
    const t = e.target.closest('.tab'); if(!t) return;
    const key = t.dataset.tab;
    document.querySelectorAll('.tab').forEach(x => x.classList.toggle('active', x===t));
    document.querySelectorAll('[data-win]').forEach(w => w.classList.toggle('hidden', w.dataset.win !== key));
  });

  // Button actions (per window)
  winsEl.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-action]'); if(!btn) return;
    try{
      if(btn.dataset.action === 'check'){
        await runCheck(btn.dataset.site);
      } else if (btn.dataset.action === 'check-all'){
        const r = await api('/site/check-all', { method:'POST' });
        (r.results||[]).forEach(applySiteStatus);
      }
    }catch(err){ alert('Gagal cek: ' + err.message); }
  });

  // Muat status + log awal
  for(const s of sites){ await refreshSite(s.key); }
}

/* ===== render helpers (per-URL health) ===== */
function applySiteStatus(summary){
  if(!summary || !summary.site) return;
  const key = summary.site;

  // init seen logs array kalau belum ada
  if (!SEEN_LOGS[key]) SEEN_LOGS[key] = new Set();

  // Summary
  const sumWrap = document.getElementById('summary-'+key);
  if(sumWrap){
    const when = new Date(summary.ts).toLocaleString();
    sumWrap.innerHTML = `
  <span class="pill ${summary.ok ? 'ok' : 'err'}">
    ${summary.ok ? '‚úÖ Semua bisa' : '‚ùå Ada yang gagal'}
  </span>
  <span class="timestamp mutetxt">Terakhir: ${when}</span>
`;

  }

  // Checks
  const checksEl = document.getElementById('checks-'+key);
  if(checksEl && Array.isArray(summary.items)){
    checksEl.innerHTML = '';
    summary.items.forEach(it => {
      const row = el(`
        <div class="check">
          <div>
            <div><b>${it.label}</b></div>
            <div class="mutetxt">
              <a href="${it.url}" target="_blank" rel="noopener">link</a>
              ${it.http ? ` ‚Ä¢ HTTP ${it.http}` : '' }
              ${it.contentType ? ` ‚Ä¢ ${it.contentType}` : '' }
              ${it.bytes ? ` ‚Ä¢ ${it.bytes} bytes` : '' }
              ${it.note ? ` ‚Ä¢ ${it.note}` : '' }
            </div>
          </div>
          <div>${state(Boolean(it.ok))}</div>
        </div>
      `);
      checksEl.appendChild(row);
    });
  }

  // Dedicated logs
  const logsEl = document.getElementById('sitelogs-'+key);
  if(logsEl){
    const logId = summary.ts + '-' + summary.ok; // gabungan waktu + status
    if (!SEEN_LOGS[key].has(logId)) {
      const line = el(`<div>${new Date(summary.ts).toLocaleString()} ‚Äî ${summary.ok ? '‚úÖ Semua bisa' : '‚ùå Ada yang gagal'}</div>`);
      if(logsEl.textContent.trim() === 'Belum ada riwayat') logsEl.innerHTML = '';
      logsEl.prepend(line);
      SEEN_LOGS[key].add(logId); // tandai sudah tampil
    }
  }
}

async function runCheck(siteKey){
  const r = await api('/site/check?site='+encodeURIComponent(siteKey), { method:'POST' });
  applySiteStatus(r.result);
}

async function refreshSite(siteKey){
  try{
    const s = await api('/site/status?site='+encodeURIComponent(siteKey));
    if(s && s.status) applySiteStatus(s.status);
    const l = await api('/site/logs?site='+encodeURIComponent(siteKey));
    if(l && Array.isArray(l.logs)){
      l.logs.forEach(entry => applySiteStatus(entry));
    }
  }catch(e){ /* biarkan diam */ }
}

/* ===== Scheduler (global) ===== */
async function refreshStatus(){
  try{
    const j = await api('/status');
    const running = j.running ? '<span class="pill ok">Running</span>' : '<span class="pill warn">Stopped</span>';
    const sched = j.schedule?.mode ? (j.schedule.mode + ' / ' + (j.schedule.value ?? '-') + ' ‚Üí ' + (j.schedule.ms ?? '-') + 'ms') : '-';
    const last = j.lastRun || {};
    document.getElementById('statusBox').innerHTML = `
      <div>State: ${running}</div>
      <div>Schedule: <b>${sched}</b></div>
      <div>Started: <b>${last.startedAt ?? '-'}</b></div>
      <div>Ended: <b>${last.endedAt ?? '-'}</b></div>
      <div>Exit Code: <b>${last.exitCode ?? '-'}</b></div>
      <div>Duration: <b>${fmtDur(last.durationMs)}</b></div>
    `;
  }catch(e){
    document.getElementById('statusBox').textContent = 'Gagal memuat status: ' + e.message;
  }
}
async function refreshLogs(){
  try{ document.getElementById('logs').textContent = await api('/logs') || 'No logs.'; }
  catch(e){ document.getElementById('logs').textContent = 'Gagal memuat logs: ' + e.message; }
}
document.getElementById('btnRun').addEventListener('click', async ()=>{ await api('/run',{method:'POST'}); await refreshStatus(); await refreshPwFailures(); });
document.getElementById('btnStart').addEventListener('click', async ()=>{
  const mode = document.getElementById('mode').value;
  const minutes = Number(document.getElementById('minutes').value||'0');
  const hours   = Number(document.getElementById('hours').value||'0');
  const value   = mode==='minutes' ? minutes : hours;
  if(!value) return alert('Isi interval > 0');
  await api(`/start?mode=${mode}&value=${value}`, { method:'POST' });
  await refreshStatus();
});
document.getElementById('btnStop').addEventListener('click', async ()=>{ await api('/stop',{method:'POST'}); await refreshStatus(); });

/* ===== Failures (Playwright) ===== */
function renderFailuresBox(data){
  const wrap = document.getElementById('pwFailures');
  const sum  = document.getElementById('pwFailSummary');
  if(!data){ sum.textContent = 'Belum ada data.'; wrap.innerHTML = ''; return; }

  sum.innerHTML = `
    Total: <b>${data.summary.total}</b> ‚Ä¢
    Passed: <b>${data.summary.passed}</b> ‚Ä¢
    Failed: <b>${data.summary.failed}</b> ‚Ä¢
    Skipped: ${data.summary.skipped} ‚Ä¢
    Flaky: ${data.summary.flaky}
  `;

  if((data.failures||[]).length === 0){
    wrap.innerHTML = '<div class="mutetxt">‚úÖ Tidak ada test yang gagal.</div>';
    return;
  }

  wrap.innerHTML = '';
  data.failures.forEach(f => {
    const links = [];
    (f.attachments || []).forEach(a => {
      if(a.href) links.push(`<a href="${a.href}" target="_blank" class="chip">${a.kind}</a>`);
    });

    // ambil label project ‚Üí fallback kalau null
    const projectLabel = PROJECT_LABELS[f.project] 
  || (f.file?.includes('tests/jr/') ? PROJECT_LABELS.jr 
      : f.file?.includes('tests/spjr/') ? PROJECT_LABELS.spjr 
      : f.title?.toLowerCase().includes('jr') ? PROJECT_LABELS.jr
      : f.title?.toLowerCase().includes('spjr') ? PROJECT_LABELS.spjr
      : f.project || "Tidak diketahui");


    const elItem = el(`
      <div class="fail-item">
        <div class="fail-head">
          <div class="chip err">‚ùå Gagal</div>
          <div class="mutetxt">${projectLabel}</div>
        </div>
        <div style="margin-top:6px"><b>${f.title}</b></div>
        <div class="mutetxt">${f.file || ''}${f.line ? ':'+f.line : ''}</div>
        ${f.error ? `<div class="mutetxt" style="margin-top:6px">${f.error}</div>` : ''}
        <div class="fail-links" style="margin-top:8px">${links.join(' ')}</div>
      </div>
    `);
    wrap.appendChild(elItem);
  });
}


async function refreshPwFailures(){
  try{
    const j = await api('/pw/summary'); // endpoint server baru
    renderFailuresBox(j);
  }catch(e){
    document.getElementById('pwFailSummary').textContent = 'Gagal memuat ringkasan: ' + e.message;
    document.getElementById('pwFailures').innerHTML = '';
  }
}

/* ===== init ===== */
loadSites();
refreshStatus(); 
refreshLogs(); 
refreshPwFailures();

setInterval(refreshStatus, 4000);
setInterval(refreshLogs, 2000);
setInterval(refreshPwFailures, 6000);

// simpan daftar key utk auto-refresh
let SITE_KEYS = [];
let siteIntervalId = null; // simpan ID interval agar bisa di-clear
const SEEN_LOGS = {}; 

async function refreshAllSites() {
  for (const k of SITE_KEYS) {
    await refreshSite(k);
  }
}

// tombol Set Auto-run
document.getElementById('btnStart').addEventListener('click', async () => {
  const mode = document.getElementById('mode').value;
  const minutes = Number(document.getElementById('minutes').value || '0');
  const hours   = Number(document.getElementById('hours').value || '0');
  const value   = mode === 'minutes' ? minutes : hours;
  if (!value) return alert('Isi interval > 0');

  const r = await api(`/start?mode=${mode}&value=${value}`, { method: 'POST' });
  await refreshStatus();

  // hitung ms sesuai pilihan user
  const ms = (mode === 'minutes' ? minutes * 60000 : hours * 3600000);

  // clear interval lama kalau ada
  if (siteIntervalId) clearInterval(siteIntervalId);
  // set interval baru
  siteIntervalId = setInterval(refreshAllSites, ms);
});

// tombol Stop Auto-run
document.getElementById('btnStop').addEventListener('click', async () => {
  await api('/stop', { method: 'POST' });
  await refreshStatus();

  if (siteIntervalId) {
    clearInterval(siteIntervalId);
    siteIntervalId = null;
  }
});





</script>
</body>
</html>
